<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Local Community Event Portal</title>
    <link rel="stylesheet" href="style.css"> 
</head>
<body>

    <header id="mainHeader">
        <div class="container">
            <h1>Community Events</h1>
            <button class="menu-button">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
                </svg>
            </button>
        </div>
    </header>

    <nav class="main-nav">
        <div class="container">
            <ul>
                <li><a href="#home">Home</a></li>
                <li><a href="#events-display-section">Events</a></li>
                <li><a href="#register-form">Register</a></li>
                <li><a href="#">Services</a></li>
                <li><a href="#feedback-form">Feedback</a></li>
                <li><a href="#contact">Contact</a></li>
                <li><a href="#">Login</a></li>
                <li><a href="#">Sign Up</a></li>
            </ul>
        </div>
    </nav>

    <main class="container">

        <div id="welcome-banner">
            <h2>Welcome Back, <span class="highlight">Logged-in User!</span></h2>
            <p>
                We're glad to see you again. Check out our <span class="highlight">special offer</span> for this month:
                <span style="color: red; font-weight: bold;">Get 20% off all premium event registrations!</span>
            </p>
        </div>

        <section id="video-invite">
            <h2>Watch Our Event Promo!</h2>
            <div class="video-wrapper">
                <iframe
                    src="https://www.youtube.com/embed/tKVSRWZI5yo?si=y6nLn-RIKWc-Xip3"
                    frameborder="0"
                    allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                    allowfullscreen
                    onload="displayVideoReadyMessage()"
                ></iframe>
            </div>
            <p id="videoStatus" class="status-message hidden">Video ready to play!</p>
        </section>

        <section id="find-events-section">
            <h2>Find Events</h2>
            <div class="search-form-wrapper">
                <input type="text" id="searchEventInput" placeholder="Search events..." class="form-input">
                <select id="filterCategorySelect" class="form-input">
                    <option value="">All Categories</option>
                    <option value="Community">Community</option>
                    <option value="Music">Music</option>
                    <option value="Art">Art</option>
                    <option value="Sports">Sports</option>
                    <option value="Food">Food</option>
                    <option value="Technology">Technology</option>
                </select>
                <button id="applyFilterButton" class="action-button">Apply Filter</button>
            </div>
        </section>

        <section id="home">
            <h2 style="color: red;">Welcome to Your Community Portal!</h2>
            <p>
                This is the central hub for all local community events and services. Here you can find information about upcoming events, register your attendance, and access various city council services. We aim to make community engagement easy and accessible for everyone.
            </p>
            <p>
                Explore the navigation above to get started. We look forward to seeing you at our next event!
            </p>
        </section>

        <section id="geolocation-section">
            <h2>Find Nearby Events</h2>
            <p>Click the button below to find events near your current location.</p>
            <button onclick="findNearbyEvents()" class="action-button green responsive-auto-width">
                Find Nearby Events
            </button>
            <div id="locationStatus" class="location-status hidden">
                <p id="locationCoordinates"></p>
                <p id="locationError" class="error-message"></p>
            </div>
        </section>

        <section id="events-display-section">
            <h2>Upcoming Events</h2>
            <div id="loadingSpinner" class="loading-spinner"></div>
            <div id="eventCardsContainer" class="event-cards-grid">
                </div>
        </section>

        <section id="access-services">
            <h3>Access Services</h3>
            <p>Find information about various city council services.</p>
            <a href="#" class="action-button">Explore Services</a>
        </section>

        <section id="news-article-section">
            <h2>Community News Bulletin</h2>
            <div class="newspaper-layout">
                <p>
                    Lorem ipsum dolor sit amet, consectetur adipiscing elit. Sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat. Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur. Excepteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum.
                </p>
                <p>
                    Curabitur pretium tincidunt lacus. Nulla gravida orci a odio. Nullam varius, turpis et commodo pharetra, est eros bibendum elit, nec luctus magna felis sollicitudin mauris. Integer in mauris eu nibh euismod gravida. Duis ac tellus et risus auctor iaculis.
                </p>
                <p>
                    Proin dictum elementum velit. Fusce euismod consequat ante. Lorem ipsum dolor sit amet, consectetur adipiscing elit. Aliquam in lorem sit amet leo accumsan lacinia. Ut sollicitudin elementum metus.
                </p>
                <p>
                    Donec at pede. Etiam vel quam. Nulla facilisi. Aenean feugiat. Sed ac lectus. Nulla facilisi. Ut in est.
                </p>
            </div>
        </section>

        <section id="register-form" class="form-container">
            <h2>Event Registration</h2>
            <form id="eventRegistrationForm">
                <div>
                    <label for="regFullName">Full Name:</label>
                    <input type="text" id="regFullName" name="fullName" placeholder="John Doe" required autofocus class="form-input">
                    <span id="regFullNameError" class="error-message-inline hidden"></span>
                </div>
                <div>
                    <label for="regEmail">Email:</label>
                    <input type="email" id="regEmail" name="email" placeholder="john.doe@example.com" required class="form-input">
                    <span id="regEmailError" class="error-message-inline hidden"></span>
                </div>
                <div>
                    <label for="regEventSelect">Select Event:</label>
                    <select id="regEventSelect" name="eventToRegister" required class="form-input">
                        <option value="">Select an Event</option>
                    </select>
                    <span id="regEventSelectError" class="error-message-inline hidden"></span>
                </div>
                <button type="submit" class="action-button" id="registerSubmitButton">Register for Event</button>
            </form>
            <div id="registrationConfirmation" class="form-confirmation hidden">
                Thank you for registering! Your registration has been received.
            </div>
        </section>

        <section id="feedback-form" class="form-container">
            <h2>Event Feedback</h2>
            <form>
                <div>
                    <label for="phoneNumber">Phone Number:</label>
                    <input type="tel" id="phoneNumber" name="phoneNumber" placeholder="e.g., 123-456-7890" class="form-input" onblur="validatePhoneNumber()">
                    <p id="phoneError" class="error-message hidden">Please enter a valid phone number (e.g., 123-456-7890).</p>
                </div>
                <div>
                    <label for="feedbackEventType">Select Event for Feedback:</label>
                    <select id="feedbackEventType" name="feedbackEventType" class="form-input" onchange="displayEventFee()">
                        <option value="">Select an Event</option>
                        <option value="community_fair">Community Fair ($10)</option>
                        <option value="music_festival">Music Festival ($25)</option>
                        <option value="art_exhibition">Art Exhibition (Free)</option>
                        <option value="charity_marathon">Charity Marathon ($15)</option>
                        <option value="farmers_market">Farmers Market (Free)</option>
                        <option value="tech_workshop">Tech Workshop ($50)</option>
                    </select>
                    <p id="eventFeeDisplay" class="event-fee-display hidden"></p>
                </div>
                <div>
                    <label for="feedbackMessage">Your Feedback:</label>
                    <textarea id="feedbackMessage" name="feedbackMessage" rows="5" placeholder="Share your thoughts about the event..." class="form-input" onkeyup="countCharacters(this, 'charCount')"></textarea>
                    <p id="charCount" class="char-count">0 characters</p>
                </div>
                <button type="button" onclick="showFeedbackConfirmation()" class="action-button">Submit Feedback</button>
            </form>
        </section>

        <section id="preferences-section">
            <h2>User Preferences</h2>
            <p>
                Your preferred event type is saved locally in your browser.
            </p>
            <button onclick="clearPreferences()" class="action-button red responsive-auto-width">
                Clear All Preferences
            </button>
            <div id="preferencesClearedMessage" class="preferences-cleared-message hidden">
                All saved preferences have been cleared.
            </div>
        </section>

        <section id="contact">
            <h2>Contact Us</h2>
            <p>
                Have questions or feedback? Feel free to reach out to us using the information below.
            </p>
            <address>
                <p><strong>Local City Council</strong></p>
                <p>123 Community Lane</p>
                <p>Civicville, CA 90210</p>
                <p>Email: <a href="mailto:info@community.org">info@community.org</a></p>
                <p>Phone: <a href="tel:+15551234567">(555) 123-4567</a></p>
            </address>
        </section>
    </main>

    <footer class="main-footer">
        <div class="container">
            <p>© 2025 Local City Council. All rights reserved.</p>
            <p class="footer-links">
                <a href="#">Privacy Policy</a> |
                <a href="#">Terms of Service</a> |
                <a href="help.html" target="_blank">Help & Support</a>
            </p>
        </div>
    </footer>

    <div id="confirmationModal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="closeModal('confirmationModal')">×</span>
            <h3>Message</h3>
            <p id="confirmationMessage"></p>
            <button onclick="closeModal('confirmationModal')">OK</button>
        </div>
    </div>

    <div id="imageModal" class="modal">
        <div id="image-modal-content">
            <span class="close-button" onclick="closeModal('imageModal')">×</span>
            <img id="enlarged-image" src="" alt="Enlarged Image">
        </div>
    </div>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>

    <script>
        // 1. JavaScript Basics & Setup
        console.log("Welcome to the Community Portal");

        // Custom message box function to replace alert()
        function showMessageBox(message, title = "Notification") {
            const modal = document.getElementById('confirmationModal');
            const modalTitle = modal.querySelector('h3');
            const modalMessage = document.getElementById('confirmationMessage');
            modalTitle.textContent = title;
            modalMessage.textContent = message;
            modal.style.display = 'flex';
        }

        // Mock API Endpoints
        const MOCK_API_BASE = 'https://api.example.com'; // Placeholder for a real API base
        const MOCK_API_EVENTS = `${MOCK_API_BASE}/events`;
        const MOCK_API_REGISTRATIONS = `${MOCK_API_BASE}/registrations`;

        // Function to simulate fetching events from an API
        async function fetchEventsFromApi() {
            // Show loading spinner
            document.getElementById('loadingSpinner').style.display = 'block';
            console.log("Fetching events..."); // Debugging: Log fetch start

            try {
                // Simulate network delay using setTimeout
                await new Promise(resolve => setTimeout(resolve, 1000));

                // In a real application, you would use fetch:
                // const response = await fetch(MOCK_API_EVENTS);
                // if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                // const data = await response.json();
                // return data;

                // For now, return a clone of the local allEvents array
                return [...allEvents]; // Using spread operator to clone the array
            } catch (error) {
                console.error("Error fetching events:", error); // Debugging: Log fetch error
                showMessageBox(`Failed to load events: ${error.message}`, "Error");
                return []; // Return empty array on error
            } finally {
                // Hide loading spinner
                document.getElementById('loadingSpinner').style.display = 'none';
                console.log("Event fetch complete."); // Debugging: Log fetch end
            }
        }

        // Function to simulate POSTing registration data to an API
        async function postRegistrationToApi(registrationData) {
            console.log("Mock API: Posting registration data:", registrationData); // Debugging: Check payload
            try {
                // Simulate network delay
                await new Promise(resolve => setTimeout(resolve, 1500));

                // In a real application, you would use fetch POST:
                /*
                const response = await fetch(MOCK_API_REGISTRATIONS, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(registrationData)
                });
                if (!response.ok) {
                    const errorDetail = await response.json();
                    throw new Error(`Registration failed: ${errorDetail.message || response.statusText}`);
                }
                return await response.json(); // Or just return success status
                */

                // Simulate success response
                return { success: true, message: "Registration successful!" };
            } catch (error) {
                console.error("API Registration error:", error); // Debugging: Log API error
                throw new Error(`API call failed: ${error.message}`);
            }
        }

        window.onload = async function() {
            showMessageBox("The page is fully loaded!");
            // Fetch events asynchronously on page load
            allEvents = await fetchEventsFromApi();
            updateEventDisplay(); // Initial display of events
            populateRegistrationEvents(); // Populate dropdown for registration
        };

        // 5. Objects and Prototypes
        // Event Class Definition
        class Event {
            constructor(id, name, date, totalSeats, category, imageUrl, description) {
                this.id = id;
                this.name = name;
                this.date = new Date(date); // Convert date string to Date object
                this.totalSeats = totalSeats;
                this.registeredSeats = 0; // Initialize registered seats
                this.category = category;
                this.imageUrl = imageUrl;
                this.description = description;
            }

            // Method to check availability
            checkAvailability() {
                return this.totalSeats - this.registeredSeats;
            }

            // Method to register a user
            register() {
                if (this.checkAvailability() > 0) {
                    this.registeredSeats++; // Use ++ to decrement seat count
                    return true;
                }
                return false;
            }

            // Method to cancel registration (demonstrates -- operator)
            cancelRegistration() {
                if (this.registeredSeats > 0) {
                    this.registeredSeats--; // Use -- to increment seat count
                    return true;
                }
                return false;
            }
        }

        // 2. Syntax, Data Types, and Operators
        // 6. Arrays and Methods
        // Initial Event Data (will be overwritten by fetchEventsFromApi on load)
        let allEvents = [
            // IMPORTANT: Use forward slashes (/) for paths and ensure correct file extensions (e.g., .jpg, .png, .gif)
            // Disk image file types (.iso, .dmg, etc.) are NOT supported by web browsers for display.
            // You can use relative paths like 'images/my-image.jpg' if the image is in a subfolder
            // named 'images' relative to your HTML file, or full URLs like 'https://example.com/my-image.png'.
            new Event('e1', 'Annual Summer Concert', '2025-07-15', 100, 'Music', 'https://www.virtualdays.com/wp-content/uploads/2023/06/community-events.jpg', 'Enjoy live music under the stars. Family-friendly event.'),
            new Event('e2', 'Food Truck Rally', '2025-08-20', 150, 'Food', 'https://st3.depositphotos.com/1037718/18382/i/450/depositphotos_183827744-stock-photo-food-truck-festival.jpg', 'A variety of food trucks, live entertainment, and fun activities.'),
            new Event('e3', 'Community Art Exhibition', '2025-06-01', 50, 'Art', 'https://th-i.thgim.com/public/incoming/fxiuih/article68968965.ece/alternates/FREE_1200/HA2A2007.JPG', 'Showcasing community talent.'),
            new Event('e4', 'Charity Marathon', '2025-09-10', 200, 'Sports', 'https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcQ19-SusW6C7xoWZSmjg5_-hwLvMzalphk5XQ&s', 'Running for a cause.'),
            new Event('e5', 'Weekly Farmers Market', '2025-05-28', 500, 'Food', 'https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcR5lST4SxyCyoxzgXNcZvAhqufDk9fiySjYyA&s', 'Fresh produce and local goods.'),
            new Event('e6', 'Tech Workshop: Web Dev', '2025-07-05', 30, 'Technology', 'https://images.stockcake.com/public/b/5/f/b5fd8cec-afa5-4237-b1e7-f9569d27e14c_large/busy-tech-workshop-stockcake.jpg', 'Learning new skills together.'),
            new Event('e7', 'Community Fair', '2024-04-20', 300, 'Community', 'https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcS4RInegObfBOzQRya3EkGx-gdAUi7dTgfS9A&s', 'Fun for all ages!'), // Past event
            new Event('e8', 'Music Festival', '2025-08-01', 0, 'Music', 'https://www.virtualdays.com/wp-content/uploads/2023/06/community-events.jpg', 'Live bands and great vibes.'), // Full event
        ];

        // 4. Functions, Scope, Closures, Higher-Order Functions
        // Function to add a new event (using .push())
        // Using default parameters for optional values
        function addEvent(name, date, totalSeats, category, imageUrl = 'https://placehold.co/250x150', description = 'No description provided.') {
            const newEvent = new Event(
                `e${allEvents.length + 1}`,
                name,
                date,
                totalSeats,
                category,
                imageUrl,
                description
            );
            allEvents.push(newEvent);
            updateEventDisplay(); // Re-render events
            populateRegistrationEvents(); // Update registration dropdown
            showMessageBox(`New event "${newEvent.name}" added successfully!`);
        }

        // Closure to track total registrations for a category
        function createCategoryRegistrationTracker() {
            const registrationsByCategory = {}; // Private variable

            return function(category) {
                if (!registrationsByCategory[category]) {
                    registrationsByCategory[category] = 0;
                }
                registrationsByCategory[category]++;
                console.log(`Total registrations for ${category}: ${registrationsByCategory[category]}`);
                return registrationsByCategory[category];
            };
        }
        const trackCategoryRegistration = createCategoryRegistrationTracker();

        // Helper function to display inline errors
        function displayInlineError(elementId, message, hide = false) {
            const errorElement = document.getElementById(elementId);
            if (errorElement) {
                errorElement.textContent = message;
                errorElement.classList.toggle('hidden', hide);
                const inputElement = document.getElementById(elementId.replace('Error', ''));
                if (inputElement) {
                    inputElement.classList.toggle('border-red-500', !hide);
                }
            }
        }

        // 7. DOM Manipulation & 3. Conditionals, Loops
        // Function to update the event display
        async function updateEventDisplay(filterCallback = null) {
            const eventCardsContainer = document.getElementById('eventCardsContainer');
            const loadingSpinner = document.getElementById('loadingSpinner');

            // Show spinner before processing
            loadingSpinner.style.display = 'block';
            $(eventCardsContainer).fadeOut(200, function() { // jQuery fadeOut
                eventCardsContainer.innerHTML = ''; // Clear existing cards

                let eventsToDisplay = [...allEvents]; // Use spread operator to clone for filtering

                // Apply filter if a callback is provided (Higher-Order Function)
                if (filterCallback && typeof filterCallback === 'function') {
                    eventsToDisplay = eventsToDisplay.filter(filterCallback);
                }

                const today = new Date();

                if (eventsToDisplay.length === 0) {
                    eventCardsContainer.innerHTML = '<p style="text-align: center; width: 100%; color: #4b5563;">No events found matching your criteria.</p>';
                } else {
                    eventsToDisplay.forEach(event => {
                        // Destructuring to extract event details
                        const { id, name, date, totalSeats, registeredSeats, category, imageUrl, description } = event;

                        const availableSeats = totalSeats - registeredSeats;
                        const isPastEvent = date < today;
                        const isFull = availableSeats <= 0;

                        // 3. Conditionals: Hide past or full events
                        if (isPastEvent || isFull) {
                            return; // Skip displaying past or full events
                        }

                        const eventCard = document.createElement('div');
                        eventCard.className = 'event-card';

                        eventCard.innerHTML = `
                            <figure>
                                <img src="${imageUrl}" alt="${name}" title="${name}" class="image-border">
                                <figcaption>${name} - ${category}</figcaption>
                            </figure>
                            <p>${description}</p>
                            <p>Date: ${date.toLocaleDateString()}</p>
                            <p>Seats Available: ${availableSeats}</p>
                            <button class="action-button register-button" data-event-id="${id}">Register</button>
                        `;

                        // Use jQuery for event listener on dynamically created buttons
                        $(eventCard).find('.register-button').on('click', function() {
                            const eventId = $(this).data('event-id');
                            registerUser(eventId);
                        });

                        eventCardsContainer.appendChild(eventCard);

                        console.log(`--- Details for ${name} ---`);
                        for (const [key, value] of Object.entries(event)) {
                            console.log(`${key}: ${value}`);
                        }
                        console.log('----------------------------');
                    });
                }
                $(eventCardsContainer).fadeIn(200); // jQuery fadeIn
                loadingSpinner.style.display = 'none'; // Hide spinner after content is ready
            });
        }

        // Function to populate the registration form's event select dropdown
        function populateRegistrationEvents() {
            const regEventSelect = document.getElementById('regEventSelect');
            regEventSelect.innerHTML = '<option value="">Select an Event</option>'; // Clear and add default

            const today = new Date();
            allEvents.forEach(event => {
                const availableSeats = event.checkAvailability();
                const isPastEvent = event.date < today;
                const isFull = availableSeats <= 0;

                if (!isPastEvent && !isFull) {
                    const option = document.createElement('option');
                    option.value = event.id;
                    option.textContent = `${event.name} (${availableSeats} seats left)`;
                    regEventSelect.appendChild(option);
                }
            });
        }

        // Function to register a user (client-side logic)
        async function registerUser(eventId) {
            try {
                const event = allEvents.find(e => e.id === eventId);
                // Set a breakpoint here to inspect 'event' object
                console.log("Attempting to register for event:", event); // Debugging: Log registration attempt

                if (!event) {
                    throw new Error("Event not found.");
                }

                if (event.register()) {
                    // Simulate backend registration
                    const registrationData = {
                        eventId: event.id,
                        eventName: event.name,
                        registrationDate: new Date().toISOString()
                    };
                    const apiResponse = await postRegistrationToApi(registrationData); // AJAX call

                    if (apiResponse.success) {
                        showMessageBox(`Successfully registered for ${event.name}! Seats left: ${event.checkAvailability()}`, "Registration Success");
                        trackCategoryRegistration(event.category); // Closure in action
                        updateEventDisplay(); // Update UI after successful registration
                        populateRegistrationEvents(); // Update dropdown
                    } else {
                        throw new Error(apiResponse.message || "Unknown API error during registration.");
                    }
                } else {
                    showMessageBox(`Sorry, ${event.name} is full or unavailable.`, "Registration Failed");
                }
            } catch (error) {
                console.error("Registration error:", error.message); // Debugging: Log client-side error
                showMessageBox(`Registration failed: ${error.message}`, "Error");
            }
        }

        // 11. Working with Forms & 12. AJAX & Fetch API
        // Event listener for the main registration form
        const eventRegistrationForm = document.getElementById('eventRegistrationForm');
        eventRegistrationForm.addEventListener('submit', async function(event) {
            event.preventDefault(); // Prevent default form submission

            console.log("Form submission initiated."); // Debugging: Log form start

            const fullNameInput = document.getElementById('regFullName');
            const emailInput = document.getElementById('regEmail');
            const eventSelect = document.getElementById('regEventSelect');

            const fullName = fullNameInput.value.trim();
            const email = emailInput.value.trim();
            const selectedEventId = eventSelect.value;

            // Basic client-side validation
            let isValid = true;
            if (!fullName) {
                displayInlineError('regFullNameError', 'Full Name is required.');
                isValid = false;
            } else {
                displayInlineError('regFullNameError', '', true);
            }

            if (!email || !email.includes('@') || !email.includes('.')) {
                displayInlineError('regEmailError', 'Please enter a valid email address.');
                isValid = false;
            } else {
                displayInlineError('regEmailError', '', true);
            }

            if (!selectedEventId) {
                displayInlineError('regEventSelectError', 'Please select an event.');
                isValid = false;
            } else {
                displayInlineError('regEventSelectError', '', true);
            }

            if (!isValid) {
                console.log("Form validation failed."); // Debugging: Log validation failure
                return;
            }

            // If validation passes, proceed with mock API registration
            try {
                // Find the event object using the selected ID
                const eventToRegister = allEvents.find(e => e.id === selectedEventId);

                if (!eventToRegister) {
                    showMessageBox("Selected event not found.", "Error");
                    return;
                }

                // Simulate registration on the event object
                if (eventToRegister.register()) {
                    // Prepare data for API POST request
                    const registrationData = {
                        fullName: fullName,
                        email: email,
                        eventId: selectedEventId,
                        eventName: eventToRegister.name,
                        registrationDate: new Date().toISOString()
                    };

                    // Send data to mock API
                    const apiResponse = await postRegistrationToApi(registrationData); // Set a breakpoint here

                    if (apiResponse.success) {
                        showMessageBox(`Registration for ${eventToRegister.name} successful!`, "Success");
                        trackCategoryRegistration(eventToRegister.category); // Update category tracker
                        updateEventDisplay(); // Refresh event cards
                        populateRegistrationEvents(); // Refresh registration dropdown
                        eventRegistrationForm.reset(); // Reset form
                        document.getElementById('registrationConfirmation').classList.remove('hidden');
                        setTimeout(() => {
                            document.getElementById('registrationConfirmation').classList.add('hidden');
                        }, 3000);
                        console.log("Form submission successful and API call simulated."); // Debugging: Log success
                    } else {
                        throw new Error(apiResponse.message || "API reported an error.");
                    }
                } else {
                    showMessageBox(`Sorry, ${eventToRegister.name} is full or unavailable.`, "Registration Failed");
                }
            } catch (error) {
                console.error("Form submission error:", error); // Debugging: Log error
                showMessageBox(`Registration failed: ${error.message}`, "Error");
            }
        });

        // 8. Event Handling: onchange for filter category
        const filterCategorySelect = document.getElementById('filterCategorySelect');
        filterCategorySelect.addEventListener('change', () => {
            const selectedCategory = filterCategorySelect.value;
            const searchTerm = document.getElementById('searchEventInput').value.toLowerCase();
            updateEventDisplay((event) => {
                const matchesCategory = selectedCategory === "" || event.category === selectedCategory;
                const matchesSearch = searchTerm === "" || event.name.toLowerCase().includes(searchTerm) || event.description.toLowerCase().includes(searchTerm);
                return matchesCategory && matchesSearch;
            });
        });

        // 8. Event Handling: keydown for quick search by name
        const searchEventInput = document.getElementById('searchEventInput');
        searchEventInput.addEventListener('keydown', (event) => {
            if (event.key === 'Enter') {
                const selectedCategory = document.getElementById('filterCategorySelect').value;
                const searchTerm = searchEventInput.value.toLowerCase();
                updateEventDisplay((event) => {
                    const matchesCategory = selectedCategory === "" || event.category === selectedCategory;
                    const matchesSearch = searchTerm === "" || event.name.toLowerCase().includes(searchTerm) || event.description.toLowerCase().includes(searchTerm);
                    return matchesCategory && matchesSearch;
                });
            }
        });

        // 14. jQuery Integration: Use jQuery for filter button click
        // Original: const applyFilterButton = document.getElementById('applyFilterButton');
        // applyFilterButton.addEventListener('click', ...);
        $('#applyFilterButton').on('click', function() {
            const selectedCategory = $('#filterCategorySelect').val();
            const searchTerm = $('#searchEventInput').val().toLowerCase();
            updateEventDisplay((event) => {
                const matchesCategory = selectedCategory === "" || event.category === selectedCategory;
                const matchesSearch = searchTerm === "" || event.name.toLowerCase().includes(searchTerm) || event.description.toLowerCase().includes(searchTerm);
                return matchesCategory && matchesSearch;
            });
            // jQuery fadeIn/fadeOut for event cards is handled within updateEventDisplay
        });


        // Existing functions (modified to use new elements/classes if needed)
        function validatePhoneNumber() {
            const phoneNumberInput = document.getElementById('phoneNumber');
            const phoneError = document.getElementById('phoneError');
            const phonePattern = /^\(?([0-9]{3})\)?[-. ]?([0-9]{3})[-. ]?([0-9]{4})$/;
            if (phoneNumberInput.value === "" || phonePattern.test(phoneNumberInput.value)) {
                phoneError.classList.add('hidden');
                phoneNumberInput.classList.remove('border-red-500');
            } else {
                phoneError.classList.remove('hidden');
                phoneNumberInput.classList.add('border-red-500');
            }
        }

        function displayEventFee() {
            const feedbackEventType = document.getElementById('feedbackEventType');
            const eventFeeDisplay = document.getElementById('eventFeeDisplay');
            const selectedOption = feedbackEventType.options[feedbackEventType.selectedIndex];
            const eventText = selectedOption.textContent;

            if (selectedOption.value === "") {
                eventFeeDisplay.classList.add('hidden');
            } else {
                const feeMatch = eventText.match(/\(\$([0-9.]+)\)/);
                const freeMatch = eventText.match(/\(Free\)/);
                if (feeMatch) {
                    eventFeeDisplay.textContent = `Event Fee: $${feeMatch[1]}`;
                } else if (freeMatch) {
                    eventFeeDisplay.textContent = `Event Fee: Free`;
                } else {
                    eventFeeDisplay.textContent = `Event Fee: Not specified`;
                }
                eventFeeDisplay.classList.remove('hidden');
            }
        }

        function showFeedbackConfirmation() {
            const feedbackMessage = document.getElementById('feedbackMessage').value;
            const feedbackEventType = document.getElementById('feedbackEventType').value;
            
            if (feedbackEventType === "") {
                showMessageBox("Please select an event type for your feedback.", "Validation Error");
            } else if (feedbackMessage.trim() === "") {
                showMessageBox("Please enter your feedback message.", "Validation Error");
            } else {
                showMessageBox(`Thank you for your feedback on the ${feedbackEventType.replace(/_/g, ' ')}! We appreciate your input.`, "Feedback Submitted");
                document.querySelector('#feedback-form form').reset();
                document.getElementById('charCount').textContent = '0 characters';
                document.getElementById('eventFeeDisplay').classList.add('hidden');
                document.getElementById('phoneNumber').classList.remove('border-red-500');
            }
        }

        function enlargeImage(imgElement) {
            const imageModal = document.getElementById('imageModal');
            const enlargedImage = document.getElementById('enlarged-image');
            enlargedImage.src = imgElement.src;
            enlargedImage.alt = imgElement.alt;
            imageModal.style.display = 'flex';
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        function countCharacters(textareaElement, countElementId) {
            const charCountElement = document.getElementById(countElementId);
            charCountElement.textContent = `${textareaElement.value.length} characters`;
        }

        function displayVideoReadyMessage() {
            document.getElementById('videoStatus').classList.remove('hidden');
        }

        // Event listener for beforeunload to check for unsaved form changes
        window.addEventListener('beforeunload', function(event) {
            const formInputs = eventRegistrationForm.querySelectorAll('input, select, textarea');
            let hasInput = false;
            for (let i = 0; i < formInputs.length; i++) {
                if (formInputs[i].value.trim() !== '') {
                    hasInput = true;
                    break;
                }
            }
            if (hasInput && document.getElementById('registrationConfirmation').classList.contains('hidden')) {
                event.preventDefault();
                event.returnValue = ''; // Standard for showing a confirmation dialog
            }
        });

        document.addEventListener('DOMContentLoaded', function() {
            const savedEventType = localStorage.getItem('preferredEventType');
            if (savedEventType) {
                document.getElementById('feedbackEventType').value = savedEventType;
            }
        });

        function clearPreferences() {
            localStorage.clear();
            sessionStorage.clear();
            const preferencesClearedMessage = document.getElementById('preferencesClearedMessage');
            preferencesClearedMessage.classList.remove('hidden');
            setTimeout(() => { preferencesClearedMessage.classList.add('hidden'); }, 3000);
            document.getElementById('feedbackEventType').value = "";
        }

        function findNearbyEvents() {
            const locationStatusDiv = document.getElementById('locationStatus');
            const locationCoordinatesP = document.getElementById('locationCoordinates');
            const locationErrorP = document.getElementById('locationError');

            locationStatusDiv.classList.remove('hidden');
            locationCoordinatesP.textContent = 'Locating...';
            locationErrorP.textContent = '';

            if (navigator.geolocation) {
                const options = { enableHighAccuracy: true, timeout: 5000, maximumAge: 0 };
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        const latitude = position.coords.latitude;
                        const longitude = position.coords.longitude;
                        locationCoordinatesP.textContent = `Latitude: ${latitude.toFixed(6)}, Longitude: ${longitude.toFixed(6)}`;
                        locationErrorP.textContent = '';
                    },
                    (error) => {
                        let errorMessage = 'Error getting location: ';
                        switch(error.code) {
                            case error.PERMISSION_DENIED: errorMessage += "User denied the request for Geolocation."; break;
                            case error.POSITION_UNAVAILABLE: errorMessage += "Location information is unavailable."; break;
                            case error.TIMEOUT: errorMessage += "The request to get user location timed out."; break;
                            case error.UNKNOWN_ERROR: errorMessage += "An unknown error occurred."; break;
                        }
                        locationCoordinatesP.textContent = '';
                        locationErrorP.textContent = errorMessage;
                    },
                    options
                );
            } else {
                locationCoordinatesP.textContent = '';
                locationErrorP.textContent = "Geolocation is not supported by this browser.";
            }
        }
    </script>

</body>
</html>
